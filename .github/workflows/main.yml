name: Check Deleted Lines with Context

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write # å¿…é¡»å¼€å¯æ­¤æƒé™æ‰èƒ½å‘è¡¨è¯„è®º

jobs:
  check-and-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Diff
        id: diff
        run: |
          # è·å– diff å¹¶ä¿å­˜åˆ°æ–‡ä»¶
          # -U0: ä¸éœ€è¦ä¸Šä¸‹æ–‡è¡Œï¼Œåªçœ‹å˜åŒ–
          BASE_REF="origin/${{ github.base_ref }}"
          HEAD_REF="origin/${{ github.head_ref }}"
          
          # å°†åŸå§‹ diff ä¿å­˜ï¼Œä¸è¦ grepï¼Œæˆ‘ä»¬éœ€è¦å®Œæ•´çš„ç»“æ„æ¥è§£æ
          git diff -U0 $BASE_REF...$HEAD_REF > full_diff.txt

      - name: Process Diff and Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            try {
              const diffContent = fs.readFileSync('full_diff.txt', 'utf8');
              const lines = diffContent.split('\n');
              
              let currentFile = '';
              let currentLineNum = 0;
              let deletedLines = [];
              
              // === è§£æé€»è¾‘ (ä¿æŒä¸å˜) ===
              lines.forEach(line => {
                if (line.startsWith('--- a/')) {
                  currentFile = line.substring(6);
                } else if (line.startsWith('--- /dev/null')) {
                  currentFile = '';
                } else if (line.startsWith('@@ ')) {
                  const match = line.match(/^@@ -(\d+)/);
                  if (match) {
                    currentLineNum = parseInt(match[1], 10);
                  }
                } else if (line.startsWith('-') && !line.startsWith('---')) {
                  if (currentFile) {
                    deletedLines.push({
                      file: currentFile,
                      line: currentLineNum,
                      content: line.substring(1) 
                    });
                    currentLineNum++;
                  }
                }
              });

              // === å¦‚æœæ²¡æœ‰åˆ é™¤è¡Œï¼Œç›´æ¥é€€å‡º ===
              if (deletedLines.length === 0) {
                console.log("æ²¡æœ‰æ£€æµ‹åˆ°åˆ é™¤è¡Œã€‚");
                return;
              }

              // === æ„å»º Markdown è¡¨æ ¼ (ä¿æŒä¸å˜) ===
              const maxDisplay = 100; 
              const now = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }); // å¯é€‰ï¼šæ·»åŠ æ—¶é—´æˆ³
              
              let tableRows = deletedLines.slice(0, maxDisplay).map(item => {
                const safeContent = item.content.replace(/`/g, '\\`');
                return `| ${item.file} | ${item.line} | \`${safeContent}\` |`;
              }).join('\n');

              let warningMsg = '';
              if (deletedLines.length > maxDisplay) {
                warningMsg = `\n> âš ï¸ åˆ é™¤è¡Œæ•°è¿‡å¤š (${deletedLines.length} è¡Œ)ï¼Œä»…æ˜¾ç¤ºå‰ ${maxDisplay} è¡Œã€‚`;
              }
              
              // æ„é€ æ–°çš„è¯„è®ºå†…å®¹
              const body = `
              ### ğŸš¨ ä»£ç åˆ é™¤æŠ¥å‘Š - ${now}
              
              æœ¬æ¬¡ PR å…±åˆ é™¤äº† **${deletedLines.length}** è¡Œä»£ç ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š
              
              <details open>
              <summary>ç‚¹å‡»æŠ˜å /å±•å¼€è¯¦ç»†åˆ—è¡¨</summary>
              
              | æ–‡ä»¶å | åŸè¡Œå· | åˆ é™¤å†…å®¹ |
              | :--- | :---: | :--- |
              ${tableRows}
              
              </details>
              ${warningMsg}
              
              ---
              *æ³¨ï¼šæ­¤è¯„è®ºç”± \`${{ github.event_name }}}\` äº‹ä»¶è§¦å‘ï¼Œè¿è¡Œäº ${{ github.sha }}ã€‚*
              `;

              // === ä»…åˆ›å»ºæ–°è¯„è®º (ç§»é™¤æŸ¥æ‰¾å’Œæ›´æ–°é€»è¾‘) ===
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
              
            } catch (error) {
              console.error("è§£ææˆ–è¯„è®ºå¤±è´¥:", error);
              // æ³¨æ„ï¼šå¦‚æœä½ ä½¿ç”¨äº† core.setFailedï¼Œä½ éœ€è¦ç¡®ä¿ actions/github-script@v7 å…·æœ‰è®¿é—® core åº“çš„æƒé™ï¼Œ
              // ä½†å¯¹äºç®€å•çš„é”™è¯¯æŠ¥å‘Šï¼Œconsole.error é…åˆæµç¨‹è‡ªç„¶å¤±è´¥é€šå¸¸å°±è¶³å¤Ÿäº†ã€‚
              // core.setFailed(error.message); 
              throw error; // æŠ›å‡ºé”™è¯¯ä»¥ä½¿ Action å¤±è´¥
            }
