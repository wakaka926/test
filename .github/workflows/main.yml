name: Check All Changes with Context

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-and-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Diff
        id: diff
        run: |
          BASE_REF="origin/${{ github.base_ref }}"
          HEAD_REF="origin/${{ github.head_ref }}"
          
          git diff -U0 $BASE_REF...$HEAD_REF > full_diff.txt

      - name: Process Diff and Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            try {
              const diffContent = fs.readFileSync('full_diff.txt', 'utf8');
              const lines = diffContent.split('\n');
              
              let currentFile = '';
              let currentOldLineNum = 0;
              let currentNewLineNum = 0;
              let deletedLines = [];
              let addedLines = [];
              
              // === è§£æé€»è¾‘ - æ•è·æ‰€æœ‰å˜æ›´ ===
              lines.forEach(line => {
                if (line.startsWith('--- a/')) {
                  currentFile = line.substring(6);
                } else if (line.startsWith('--- /dev/null')) {
                  currentFile = '';
                } else if (line.startsWith('+++ b/')) {
                  // æ–°æ–‡ä»¶
                  if (currentFile === '') {
                    currentFile = line.substring(6);
                  }
                } else if (line.startsWith('@@ ')) {
                  // è§£æè¡Œå·ä¿¡æ¯: @@ -oldStart,oldCount +newStart,newCount @@
                  const match = line.match(/^@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@/);
                  if (match) {
                    currentOldLineNum = parseInt(match[1], 10);
                    currentNewLineNum = parseInt(match[2], 10);
                  }
                } else if (line.startsWith('-') && !line.startsWith('---')) {
                  // åˆ é™¤çš„è¡Œ
                  if (currentFile) {
                    deletedLines.push({
                      file: currentFile,
                      line: currentOldLineNum,
                      content: line.substring(1),
                      type: 'deleted'
                    });
                    currentOldLineNum++;
                  }
                } else if (line.startsWith('+') && !line.startsWith('+++')) {
                  // æ·»åŠ çš„è¡Œ
                  if (currentFile) {
                    addedLines.push({
                      file: currentFile,
                      line: currentNewLineNum,
                      content: line.substring(1),
                      type: 'added'
                    });
                    currentNewLineNum++;
                  }
                } else if (line.startsWith(' ')) {
                  // æœªå˜æ›´çš„ä¸Šä¸‹æ–‡è¡Œï¼ˆå¦‚æœä½¿ç”¨äº† -U0 åˆ™ä¸ä¼šå‡ºç°ï¼‰
                  currentOldLineNum++;
                  currentNewLineNum++;
                }
              });

              // === åˆå¹¶æ‰€æœ‰å˜æ›´ ===
              const allChanges = [...deletedLines, ...addedLines];
              
              if (allChanges.length === 0) {
                console.log("æ²¡æœ‰æ£€æµ‹åˆ°ä»£ç å˜æ›´ã€‚");
                return;
              }

              // === æ„å»ºç»Ÿè®¡ä¿¡æ¯ ===
              const stats = {
                total: allChanges.length,
                deleted: deletedLines.length,
                added: addedLines.length,
                files: new Set([...deletedLines.map(d => d.file), ...addedLines.map(a => a.file)]).size
              };

              // === æ„å»º Markdown è¡¨æ ¼ ===
              const maxDisplay = 100;
              const now = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
              
              // åˆ†åˆ«å±•ç¤ºåˆ é™¤å’Œæ·»åŠ çš„è¡Œ
              let deletedTableRows = '';
              if (deletedLines.length > 0) {
                deletedTableRows = deletedLines.slice(0, Math.min(50, deletedLines.length)).map(item => {
                  const safeContent = item.content.replace(/`/g, '\\`').replace(/\|/g, '\\|');
                  return `| ${item.file} | ${item.line} | \`${safeContent}\` |`;
                }).join('\n');
              }

              let addedTableRows = '';
              if (addedLines.length > 0) {
                addedTableRows = addedLines.slice(0, Math.min(50, addedLines.length)).map(item => {
                  const safeContent = item.content.replace(/`/g, '\\`').replace(/\|/g, '\\|');
                  return `| ${item.file} | ${item.line} | \`${safeContent}\` |`;
                }).join('\n');
              }

              // æ„é€ è¯„è®ºå†…å®¹
              const body = `
### ğŸ“Š ä»£ç å˜æ›´æŠ¥å‘Š - ${now}

æœ¬æ¬¡ PR å…±æ¶‰åŠ **${stats.files}** ä¸ªæ–‡ä»¶ï¼Œå˜æ›´ **${stats.total}** è¡Œä»£ç ï¼š
- â– åˆ é™¤ï¼š**${stats.deleted}** è¡Œ
- â• æ·»åŠ ï¼š**${stats.added}** è¡Œ

${deletedLines.length > 0 ? `
<details ${deletedLines.length <= 20 ? 'open' : ''}>
<summary>ğŸ”´ åˆ é™¤çš„ä»£ç è¡Œ (${deletedLines.length} è¡Œ)</summary>

| æ–‡ä»¶å | åŸè¡Œå· | åˆ é™¤å†…å®¹ |
| :--- | :---: | :--- |
${deletedTableRows}

${deletedLines.length > 50 ? `> âš ï¸ åˆ é™¤è¡Œæ•°è¿‡å¤šï¼Œä»…æ˜¾ç¤ºå‰ 50 è¡Œã€‚` : ''}

</details>
` : ''}

${addedLines.length > 0 ? `
<details ${addedLines.length <= 20 ? 'open' : ''}>
<summary>ğŸŸ¢ æ·»åŠ çš„ä»£ç è¡Œ (${addedLines.length} è¡Œ)</summary>

| æ–‡ä»¶å | æ–°è¡Œå· | æ·»åŠ å†…å®¹ |
| :--- | :---: | :--- |
${addedTableRows}

${addedLines.length > 50 ? `> âš ï¸ æ·»åŠ è¡Œæ•°è¿‡å¤šï¼Œä»…æ˜¾ç¤ºå‰ 50 è¡Œã€‚` : ''}

</details>
` : ''}

---
*æ­¤è¯„è®ºç”± \`${{ github.event_name }}\` äº‹ä»¶è§¦å‘ï¼Œè¿è¡Œäº ${{ github.sha }}ã€‚*
              `;

              // === åˆ›å»ºè¯„è®º ===
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
              
            } catch (error) {
              console.error("è§£ææˆ–è¯„è®ºå¤±è´¥:", error);
              throw error;
            }
