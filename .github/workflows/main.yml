name: Check All Changes with Context

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-and-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Diff
        id: diff
        run: |
          BASE_REF="origin/${{ github.base_ref }}"
          HEAD_REF="origin/${{ github.head_ref }}"
          
          git diff -U0 $BASE_REF...$HEAD_REF > full_diff.txt

      - name: Process Diff and Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            try {
              const diffContent = fs.readFileSync('full_diff.txt', 'utf8');
              const lines = diffContent.split('\n');
              
              let currentFile = '';
              let currentOldLineNum = 0;
              let currentNewLineNum = 0;
              let deletedLines = [];
              let addedLines = [];
              let modifiedLines = [];
              
              let pendingDeletes = [];
              let pendingAdds = [];
              
              const flushPending = () => {
                if (pendingDeletes.length > 0 && pendingAdds.length > 0) {
                  const minLen = Math.min(pendingDeletes.length, pendingAdds.length);
                  for (let i = 0; i < minLen; i++) {
                    modifiedLines.push({
                      file: pendingDeletes[i].file,
                      oldLine: pendingDeletes[i].line,
                      newLine: pendingAdds[i].line,
                      oldContent: pendingDeletes[i].content,
                      newContent: pendingAdds[i].content,
                      type: 'modified'
                    });
                  }
                  for (let i = minLen; i < pendingDeletes.length; i++) {
                    deletedLines.push(pendingDeletes[i]);
                  }
                  for (let i = minLen; i < pendingAdds.length; i++) {
                    addedLines.push(pendingAdds[i]);
                  }
                } else {
                  deletedLines.push(...pendingDeletes);
                  addedLines.push(...pendingAdds);
                }
                pendingDeletes = [];
                pendingAdds = [];
              };
              
              lines.forEach((line, index) => {
                if (line.startsWith('--- a/')) {
                  flushPending();
                  currentFile = line.substring(6);
                } else if (line.startsWith('--- /dev/null')) {
                  flushPending();
                  currentFile = '';
                } else if (line.startsWith('+++ b/')) {
                  if (currentFile === '') {
                    currentFile = line.substring(6);
                  }
                } else if (line.startsWith('@@ ')) {
                  flushPending();
                  const match = line.match(/^@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@/);
                  if (match) {
                    currentOldLineNum = parseInt(match[1], 10);
                    currentNewLineNum = parseInt(match[2], 10);
                  }
                } else if (line.startsWith('-') && !line.startsWith('---')) {
                  if (currentFile) {
                    pendingDeletes.push({
                      file: currentFile,
                      line: currentOldLineNum,
                      content: line.substring(1),
                      type: 'deleted'
                    });
                    currentOldLineNum++;
                  }
                } else if (line.startsWith('+') && !line.startsWith('+++')) {
                  if (currentFile) {
                    pendingAdds.push({
                      file: currentFile,
                      line: currentNewLineNum,
                      content: line.substring(1),
                      type: 'added'
                    });
                    currentNewLineNum++;
                  }
                } else if (line.startsWith(' ')) {
                  flushPending();
                  currentOldLineNum++;
                  currentNewLineNum++;
                } else {
                  if (index === lines.length - 1 || 
                      lines[index + 1].startsWith('@@') || 
                      lines[index + 1].startsWith('---')) {
                    flushPending();
                  }
                }
              });
              
              flushPending();

              const allChanges = [...deletedLines, ...addedLines, ...modifiedLines];
              
              if (allChanges.length === 0) {
                console.log("æ²¡æœ‰æ£€æµ‹åˆ°ä»£ç å˜æ›´ã€‚");
                return;
              }

              const stats = {
                total: deletedLines.length + addedLines.length + modifiedLines.length,
                deleted: deletedLines.length,
                added: addedLines.length,
                modified: modifiedLines.length,
                files: new Set([
                  ...deletedLines.map(d => d.file), 
                  ...addedLines.map(a => a.file),
                  ...modifiedLines.map(m => m.file)
                ]).size
              };

              const now = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
              
              let modifiedTableRows = '';
              if (modifiedLines.length > 0) {
                modifiedTableRows = modifiedLines.slice(0, Math.min(50, modifiedLines.length)).map(item => {
                  const safeOld = item.oldContent.replace(/`/g, '\\`').replace(/\|/g, '\\|');
                  const safeNew = item.newContent.replace(/`/g, '\\`').replace(/\|/g, '\\|');
                  return `| ${item.file} | ${item.oldLine} â†’ ${item.newLine} | \`${safeOld}\` | \`${safeNew}\` |`;
                }).join('\n');
              }
              
              let deletedTableRows = '';
              if (deletedLines.length > 0) {
                deletedTableRows = deletedLines.slice(0, Math.min(50, deletedLines.length)).map(item => {
                  const safeContent = item.content.replace(/`/g, '\\`').replace(/\|/g, '\\|');
                  return `| ${item.file} | ${item.line} | \`${safeContent}\` |`;
                }).join('\n');
              }

              let addedTableRows = '';
              if (addedLines.length > 0) {
                addedTableRows = addedLines.slice(0, Math.min(50, addedLines.length)).map(item => {
                  const safeContent = item.content.replace(/`/g, '\\`').replace(/\|/g, '\\|');
                  return `| ${item.file} | ${item.line} | \`${safeContent}\` |`;
                }).join('\n');
              }

              let bodyParts = [];
              bodyParts.push(`### ğŸ“Š ä»£ç å˜æ›´æŠ¥å‘Š - ${now}\n`);
              bodyParts.push(`æœ¬æ¬¡ PR å…±æ¶‰åŠ **${stats.files}** ä¸ªæ–‡ä»¶ï¼Œå˜æ›´ **${stats.total}** å¤„ï¼š`);
              bodyParts.push(`- ğŸ”„ ä¿®æ”¹ï¼š**${stats.modified}** å¤„`);
              bodyParts.push(`- â– åˆ é™¤ï¼š**${stats.deleted}** è¡Œ`);
              bodyParts.push(`- â• æ·»åŠ ï¼š**${stats.added}** è¡Œ\n`);

              if (modifiedLines.length > 0) {
                const detailsOpen = modifiedLines.length <= 20 ? 'open' : '';
                bodyParts.push(`<details ${detailsOpen}>`);
                bodyParts.push(`<summary>ğŸ”„ ä¿®æ”¹çš„ä»£ç è¡Œ (${modifiedLines.length} å¤„)</summary>\n`);
                bodyParts.push(`| æ–‡ä»¶å | è¡Œå·å˜åŒ– | ä¿®æ”¹å‰ | ä¿®æ”¹å |`);
                bodyParts.push(`| :--- | :---: | :--- | :--- |`);
                bodyParts.push(modifiedTableRows);
                if (modifiedLines.length > 50) {
                  bodyParts.push(`\n> âš ï¸ ä¿®æ”¹è¡Œæ•°è¿‡å¤šï¼Œä»…æ˜¾ç¤ºå‰ 50 è¡Œã€‚`);
                }
                bodyParts.push(`\n</details>\n`);
              }

              if (deletedLines.length > 0) {
                const detailsOpen = deletedLines.length <= 20 ? 'open' : '';
                bodyParts.push(`<details ${detailsOpen}>`);
                bodyParts.push(`<summary>ğŸ”´ åˆ é™¤çš„ä»£ç è¡Œ (${deletedLines.length} è¡Œ)</summary>\n`);
                bodyParts.push(`| æ–‡ä»¶å | åŸè¡Œå· | åˆ é™¤å†…å®¹ |`);
                bodyParts.push(`| :--- | :---: | :--- |`);
                bodyParts.push(deletedTableRows);
                if (deletedLines.length > 50) {
                  bodyParts.push(`\n> âš ï¸ åˆ é™¤è¡Œæ•°è¿‡å¤šï¼Œä»…æ˜¾ç¤ºå‰ 50 è¡Œã€‚`);
                }
                bodyParts.push(`\n</details>\n`);
              }

              if (addedLines.length > 0) {
                const detailsOpen = addedLines.length <= 20 ? 'open' : '';
                bodyParts.push(`<details ${detailsOpen}>`);
                bodyParts.push(`<summary>ğŸŸ¢ æ·»åŠ çš„ä»£ç è¡Œ (${addedLines.length} è¡Œ)</summary>\n`);
                bodyParts.push(`| æ–‡ä»¶å | æ–°è¡Œå· | æ·»åŠ å†…å®¹ |`);
                bodyParts.push(`| :--- | :---: | :--- |`);
                bodyParts.push(addedTableRows);
                if (addedLines.length > 50) {
                  bodyParts.push(`\n> âš ï¸ æ·»åŠ è¡Œæ•°è¿‡å¤šï¼Œä»…æ˜¾ç¤ºå‰ 50 è¡Œã€‚`);
                }
                bodyParts.push(`\n</details>\n`);
              }

              bodyParts.push(`---`);
              bodyParts.push(`*æ­¤è¯„è®ºç”± \`${{ github.event_name }}\` äº‹ä»¶è§¦å‘ï¼Œè¿è¡Œäº ${{ github.sha }}ã€‚*`);

              const body = bodyParts.join('\n');

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
              
            } catch (error) {
              console.error("è§£ææˆ–è¯„è®ºå¤±è´¥:", error);
              throw error;
            }
