name: Check Deleted Lines with Context

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-and-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Diff
        id: diff
        run: |
          # è·å– diff å¹¶ä¿å­˜åˆ°æ–‡ä»¶
          # -U0: ä¸éœ€è¦ä¸Šä¸‹æ–‡è¡Œï¼Œåªçœ‹å˜åŒ–
          BASE_REF="origin/${{ github.base_ref }}"
          HEAD_REF="origin/${{ github.head_ref }}"
          
          # å°†åŸå§‹ diff ä¿å­˜ï¼Œä¸è¦ grepï¼Œæˆ‘ä»¬éœ€è¦å®Œæ•´çš„ç»“æ„æ¥è§£æ
          git diff -U0 $BASE_REF...$HEAD_REF > full_diff.txt

      - name: Process Diff and Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            try {
              const diffContent = fs.readFileSync('full_diff.txt', 'utf8');
              const lines = diffContent.split('\n');
              
              let currentFile = '';
              let currentLineNum = 0;
              let deletedLines = [];
              
              // === è§£æé€»è¾‘ ===
              lines.forEach(line => {
                // 1. æ•æ‰æ–‡ä»¶å (æ ¼å¼: --- a/path/to/file)
                if (line.startsWith('--- a/')) {
                  currentFile = line.substring(6); // å»æ‰å‰é¢çš„ "--- a/"
                } 
                // å¿½ç•¥ /dev/null çš„æƒ…å†µï¼ˆé€šå¸¸æ˜¯æ–°å¢æ–‡ä»¶ï¼Œæ²¡æœ‰åˆ é™¤è¡Œï¼‰
                else if (line.startsWith('--- /dev/null')) {
                  currentFile = '';
                }
                // 2. æ•æ‰å—å¤´è·å–è¡Œå· (æ ¼å¼: @@ -10,2 +10,0 @@)
                else if (line.startsWith('@@ ')) {
                  // æ­£åˆ™æå– - åé¢çš„æ•°å­—ï¼Œå³åŸæ–‡ä»¶çš„èµ·å§‹è¡Œå·
                  const match = line.match(/^@@ -(\d+)/);
                  if (match) {
                    currentLineNum = parseInt(match[1], 10);
                  }
                }
                // 3. æ•æ‰åˆ é™¤è¡Œ (ä»¥ - å¼€å¤´ï¼Œä½†ä¸æ˜¯ --- æˆ–å…¶ä»–å…ƒæ•°æ®)
                else if (line.startsWith('-') && !line.startsWith('---')) {
                  if (currentFile) {
                    // ä¿å­˜ç»“æœï¼šæ–‡ä»¶å | è¡Œå· | ä»£ç å†…å®¹
                    // content.substring(1) æ˜¯ä¸ºäº†å»æ‰è¡Œé¦–çš„ '-' å·
                    deletedLines.push({
                      file: currentFile,
                      line: currentLineNum,
                      content: line.substring(1) 
                    });
                    
                    // åŒä¸€ä¸ªå—å†…çš„è¿ç»­åˆ é™¤ï¼Œè¡Œå·é€’å¢
                    currentLineNum++;
                  }
                }
                // æ³¨æ„ï¼šå¦‚æœåªæ˜¯ä¸Šä¸‹æ–‡è¡Œæˆ–æ–°å¢è¡Œï¼ˆ+ï¼‰ï¼Œä¸ç”¨é€’å¢åŸæ–‡ä»¶è¡Œå·çš„è®¡æ•°å™¨
                // ä½†å› ä¸ºæˆ‘ä»¬ç”¨äº† -U0ï¼Œç†è®ºä¸Šå¾ˆå°‘æœ‰ä¸Šä¸‹æ–‡è¡Œï¼Œé™¤é diff æ ¼å¼ç‰¹æ®Š
              });

              // === å¦‚æœæ²¡æœ‰åˆ é™¤è¡Œï¼Œç›´æ¥é€€å‡º ===
              if (deletedLines.length === 0) {
                console.log("æ²¡æœ‰æ£€æµ‹åˆ°åˆ é™¤è¡Œã€‚");
                return;
              }

              // === æ„å»º Markdown è¡¨æ ¼ ===
              // ä¸ºäº†é˜²æ­¢è¯„è®ºè¿‡é•¿ï¼Œå¦‚æœè¶…è¿‡ 50 è¡Œï¼Œå»ºè®®åªæ˜¾ç¤ºä¸€éƒ¨åˆ†æˆ–æç¤º
              const maxDisplay = 100; 
              let tableRows = deletedLines.slice(0, maxDisplay).map(item => {
                // å¯¹ä»£ç å†…å®¹é‡Œçš„ ` ç¬¦å·è¿›è¡Œè½¬ä¹‰ï¼Œé˜²æ­¢ç ´å Markdown æ ¼å¼
                const safeContent = item.content.replace(/`/g, '\\`');
                // ç”Ÿæˆä¸€è¡Œè¡¨æ ¼
                return `| ${item.file} | ${item.line} | \`${safeContent}\` |`;
              }).join('\n');

              let warningMsg = '';
              if (deletedLines.length > maxDisplay) {
                warningMsg = `\n> âš ï¸ åˆ é™¤è¡Œæ•°è¿‡å¤š (${deletedLines.length} è¡Œ)ï¼Œä»…æ˜¾ç¤ºå‰ ${maxDisplay} è¡Œã€‚`;
              }

              const body = `
              ### ğŸš¨ ä»£ç åˆ é™¤æŠ¥å‘Š
              
              æœ¬æ¬¡ PR å…±åˆ é™¤äº† **${deletedLines.length}** è¡Œä»£ç ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š
              
              <details open>
              <summary>ç‚¹å‡»æŠ˜å /å±•å¼€è¯¦ç»†åˆ—è¡¨</summary>
              
              | æ–‡ä»¶å | åŸè¡Œå· | åˆ é™¤å†…å®¹ |
              | :--- | :---: | :--- |
              ${tableRows}
              
              </details>
              ${warningMsg}
              `;

              // === å‘é€/æ›´æ–°è¯„è®º (å¸¦æœ‰é˜²é‡å¤é€»è¾‘) ===
              const comments = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const botComment = comments.data.find(c => 
                c.user.type === 'Bot' && c.body.includes('### ğŸš¨ ä»£ç åˆ é™¤æŠ¥å‘Š')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  comment_id: botComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body
                });
              } else {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body
                });
              }

            } catch (error) {
              console.error("è§£ææˆ–è¯„è®ºå¤±è´¥:", error);
              core.setFailed(error.message);
            }
